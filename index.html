<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√âtat des lieux ‚Äì Entr√©e / Sortie</title>
  <meta name="description" content="Application 100% front pour r√©aliser des √©tats des lieux (entr√©e/sortie), signer, et exporter en PDF (2 exemplaires)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF + SignaturePad -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b1020; --card:#121935; --muted:#98a2b3; --txt:#e8efff; --acc:#5b8cff; --good:#1db954; --bad:#ff5b6b; --warn:#ffb020;
      --br:14px; --gap:14px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%); color:var(--txt)}
    .wrap{max-width:1100px;margin:36px auto;padding:0 20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:42px;height:42px;border-radius:12px;background:#18224e;display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo b{font-size:20px}
    h1{font-size:28px;margin:0}
    .sub{color:var(--muted)}
    .bar{position:sticky;top:0;background:rgba(11,16,32,.7);backdrop-filter:blur(8px);z-index:5;padding:12px 0;border-bottom:1px solid #1f2b5e}
    .steps{display:grid;grid-template-columns:repeat(8,1fr);gap:12px}
    .step{background:#0d1636;border:1px solid #1f2b5e;color:var(--muted);padding:10px;border-radius:12px;text-align:center;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .step.active{border-color:var(--acc);color:#fff;box-shadow:0 0 0 2px rgba(91,140,255,.2) inset}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:linear-gradient(180deg,#121935 0%,#0f1734 100%);border:1px solid #1f2b5e;border-radius:var(--br);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;font-size:13px;color:#c8d4ff;margin:10px 0 6px}
    input[type="text"], input[type="email"], input[type="number"], select, textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid #27336a;background:#0b1535;color:#fff;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    .muted{color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:#0a2a5f;border:1px solid #1f3d82;color:#dfe8ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#1a2b62;color:#fff;font-weight:600;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#5b8cff,#3a69ff)}
    button.ghost{background:#0d1636;border:1px solid #27336a;color:#c8d4ff}
    button.warn{background:linear-gradient(180deg,#ff8a34,#ff5e34)}
    .counter{display:flex;align-items:center;gap:8px}
    .counter input{width:80px;text-align:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:#0d1e46;border:1px solid #2b3e7e;font-size:12px}
    .room{border:1px dashed #2d3b79;padding:12px;border-radius:12px;margin-top:10px}
    .photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px}
    .photo{position:relative;border-radius:10px;overflow:hidden;border:1px solid #2a3a7a}
    .photo img{width:100%;height:100%;object-fit:cover;display:block}
    .photo small{position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,.55);padding:2px 6px;border-radius:999px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0c1c45;border:1px solid #2e3f81;padding:2px 7px;border-radius:6px}
    .sticky-actions{position:sticky;bottom:12px;display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .success{color:var(--good)}
    .danger{color:var(--bad)}
    .badge{display:inline-block;border:1px solid #31448a;padding:4px 8px;border-radius:8px;margin-left:8px;color:#cfe0ff;font-size:12px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#213172,transparent);margin:14px 0}
    .sig-pad{width:100%;border:1px dashed #2d3b79;border-radius:12px;background:#07102b}
    .helper{font-size:12px;color:#a7b5e6;margin-top:6px}
    .checkbox{display:flex;gap:10px;align-items:center}
    .checkbox input{width:18px;height:18px}
    .toast{position:fixed;right:16px;bottom:16px;background:#0f1c44;border:1px solid #3050a0;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:none}
    .small{font-size:12px}
    .inline{display:inline}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid #27336a;padding:8px;border-radius:6px}
    .table th{background:#0d1636;text-align:left}
    .hint{color:#bfd0ff}
    .dlist{position:relative}
    .dlist .opt{position:absolute;top:100%;left:0;right:0;background:#0b1535;border:1px solid #27336a;border-top:none;border-radius:0 0 12px 12px;max-height:220px;overflow:auto;z-index:10}
    .dlist .opt div{padding:8px 10px;border-bottom:1px solid #1b2a63;cursor:pointer}
    .dlist .opt div:hover{background:#122665}
  </style>
</head>
<body>
  <div class="bar">
    <div class="wrap">
      <div class="steps" id="steps"></div>
    </div>
  </div>
  <div class="wrap">
    <header>
      <div class="logo"><b>EDL</b></div>
      <div>
        <h1>√âtat des lieux ‚Äì Entr√©e / Sortie <span id="badgeSaved" class="badge">Brouillon non enregistr√©</span></h1>
        <div class="sub">Application locale, fonctionne hors ligne. Les donn√©es restent sur votre appareil (localStorage). Export PDF en 2 exemplaires.</div>
      </div>
    </header>

    <div class="grid">
      <div class="card" id="formArea"></div>
      <div class="card" id="previewArea">
        <h2>R√©sum√©</h2>
        <div id="summary"></div>
        <div class="divider"></div>
        <div class="actions">
          <button class="ghost" id="btnExportJSON">Exporter JSON</button>
          <button class="ghost" id="btnImportJSON">Importer JSON</button>
          <button class="warn" id="btnReset">R√©initialiser</button>
        </div>
        <div class="sticky-actions">
          <button id="btnPDF" class="primary">üìÑ T√©l√©charger le PDF (2 exemplaires)</button>
        </div>
        <p class="muted small">Astuce¬†: la signature se fait √† l'√©tape 12. Les photos sont compress√©es automatiquement pour all√©ger le PDF.</p>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
// ====== CONFIG ======
const ADDRESS_PROVIDER = 'gouv'; // 'gouv' (par d√©faut, France, sans cl√©) ou 'google'
const GOOGLE_PLACES_API_KEY = '';

// ====== STATE ======
const emptyState = () => ({
  edlType: 'entr√©e',
  home: { kind: 'appartement', address: { voie:'', cp:'', ville:'', search:'' } },
  roomCounts: { salon:0, cuisine:0, chambre:0, sdb:0, wc:0, autres:[] },
  performer: { role:'proprietaire', firstname:'', lastname:'', email:'', address:{ voie:'', cp:'', ville:'', search:'' } },
  tenant: { firstname:'', lastname:'', email:'', address:{ voie:'', cp:'', ville:'', search:'' }, useHomeAddress:true },
  features: { type:'appartement', surface:'', pieces:'', meuble:false, chauffage:{type:'individuel', mode:'√©lectrique'}, eau:{type:'individuel', mode:'√©lectrique'}, smoke:false },
  rooms: [], // filled later from counts
  meters: { water:{number:'', photo:null, comment:''}, electricity:{number:'', photo:null, comment:''} },
  keys: { count:0, photo:null, comment:'' },
  remarks: { photos:[], comment:'' },
  signatures: { owner:null, tenant:null },
  createdAt: new Date().toISOString()
});
let state = loadState() || emptyState();
let saveTimer;

function saveState(){
  localStorage.setItem('edlForm', JSON.stringify(state));
  markSaved(true);
}
function loadState(){
  try{ const s = JSON.parse(localStorage.getItem('edlForm')); return s && typeof s === 'object' ? s : null; }catch(e){ return null; }
}
function markSaved(ok){
  const el = document.getElementById('badgeSaved');
  if(ok){ el.textContent = 'Brouillon enregistr√©'; el.style.borderColor = '#2e7d32'; el.style.color = '#b6ffd0'; }
  else { el.textContent = 'Brouillon non enregistr√©'; el.style.borderColor = '#31448a'; el.style.color = '#cfe0ff'; }
}
function deferSave(){ markSaved(false); clearTimeout(saveTimer); saveTimer = setTimeout(saveState, 500); }

// ====== UI HELPERS ======
function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2), v); else e.setAttribute(k,v);
  }
  for (const c of (Array.isArray(children)?children:[children])) if(c!=null) e.appendChild(typeof c==='string'?document.createTextNode(c):c);
  return e;
}
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none'},2000) }

// ====== STEPS ======
const steps = [
  '1. Type', '2. Bien', '3. Adresse', '4. Pi√®ces', '5. R√©alisateur', '6. Coordonn√©es', '7. Locataire', '8. Caract√©ristiques', '9. √âtat des pi√®ces', '10. Compteurs', '11. Cl√©s', '12. Signatures', '13. Remarques', '14. Export'
];
let current = 0;

function renderSteps(){
  const s = document.getElementById('steps'); s.innerHTML='';
  steps.forEach((name,i)=> s.appendChild(el('div',{class:'step'+(i===current?' active':'')}, name)) );
}

function next(){ if(current<steps.length-1){ current++; render(); } }
function prev(){ if(current>0){ current--; render(); } }

function navActions(){
  return el('div',{class:'actions'},[
    el('button',{class:'ghost',onClick:prev},'‚Üê Pr√©c√©dent'),
    el('button',{class:'primary',onClick:next},'Suivant ‚Üí'),
  ]);
}

// ====== ADDRESS AUTOCOMPLETE ======
function makeAddressBlock(obj){
  const wrap = el('div');
  const searchId = 'dl_'+Math.random().toString(36).slice(2);
  const dwrap = el('div',{class:'dlist'});
  const search = el('input',{type:'text',placeholder:'Commencez √† taper une adresse‚Ä¶', value: obj.address.search||'' , onInput: onType});
  const options = el('div',{class:'opt',style:'display:none'});
  dwrap.append(search, options);

  async function onType(){
    obj.address.search = search.value; deferSave();
    const q = search.value.trim();
    if(q.length<3){ options.style.display='none'; options.innerHTML=''; return; }
    let list=[];
    if(ADDRESS_PROVIDER==='gouv'){
      const r = await fetch('https://api-adresse.data.gouv.fr/search/?limit=5&q='+encodeURIComponent(q));
      const js = await r.json();
      list = (js.features||[]).map(f=>({label:f.properties.label, voie:f.properties.name||'', cp:f.properties.postcode||'', ville:f.properties.city||f.properties.context||''}));
    } else if(ADDRESS_PROVIDER==='google' && GOOGLE_PLACES_API_KEY){
      // Lightweight Places Autocomplete via Places API Text Search (client-side). Note: this may incur costs.
      const r = await fetch('https://maps.googleapis.com/maps/api/place/textsearch/json?region=fr&query='+encodeURIComponent(q)+'&key='+GOOGLE_PLACES_API_KEY);
      const js = await r.json();
      list = (js.results||[]).slice(0,5).map(r=>({label:r.formatted_address, voie:r.name||'', cp:'', ville:''}));
    }
    options.innerHTML='';
    list.forEach(item=>{
      const row = el('div',{onClick:()=>{
        search.value=item.label; obj.address.search=item.label; obj.address.voie=item.voie; obj.address.cp=item.cp; obj.address.ville=item.ville; update(); options.style.display='none'; deferSave();
      }}, item.label);
      options.appendChild(row);
    });
    options.style.display = list.length? 'block':'none';
  }

  const voie = el('input',{type:'text',placeholder:'Num√©ro et libell√© de voie', value: obj.address.voie||'', onInput:e=>{obj.address.voie=e.target.value; deferSave();}});
  const cpVille = el('div',{class:'row'},[
    el('input',{type:'text',placeholder:'Code postal', value: obj.address.cp||'', onInput:e=>{obj.address.cp=e.target.value; deferSave();}}),
    el('input',{type:'text',placeholder:'Ville', value: obj.address.ville||'', onInput:e=>{obj.address.ville=e.target.value; deferSave();}}),
  ]);

  wrap.append(
    el('label',{},'Recherche d‚Äôadresse (auto-compl√©tion)'), dwrap,
    el('label',{},'Num√©ro et libell√© de voie'), voie,
    el('label',{},'Code postal / Ville'), cpVille,
  );
  return wrap;
}

// ====== IMAGE UTILS ======
function fileToDataURL(file){
  return new Promise((res,rej)=>{ const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
async function compressImage(file, maxW=1600, quality=0.75){
  const url = await fileToDataURL(file);
  const img = new Image();
  img.src = url; await img.decode();
  const scale = Math.min(1, maxW/img.width);
  const w = Math.round(img.width*scale), h=Math.round(img.height*scale);
  const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return c.toDataURL('image/jpeg', quality);
}

// ====== FORMS (BY STEP) ======
function render(){
  renderSteps();
  const area = document.getElementById('formArea'); area.innerHTML='';
  area.appendChild(stepContent());
  renderSummary();
}

function stepContent(){
  if(current===0){
    const box = el('div');
    box.append(
      el('h2',{},'1. Quel type d\'√©tat des lieux souhaitez-vous cr√©er ?'),
      el('div',{class:'row'},[
        el('div',{},[
          el('label',{},'Type d\'√©tat des lieux'),
          (()=>{ const s=el('select',{onInput:e=>{state.edlType=e.target.value; deferSave();}}, [el('option',{value:'entr√©e'},'Entr√©e'), el('option',{value:'sortie'},'Sortie')]); s.value=state.edlType; return s; })(),
        ]),
        el('div',{},[
          el('label',{},'Date'),
          (()=>{ const i = el('input',{type:'text',value:new Date().toLocaleDateString('fr-FR'),disabled:true}); return i; })(),
        ])
      ]),
      navActions()
    );
    return box;
  }

  if(current===1){
    const box=el('div');
    box.append(
      el('h2',{},'2. Lequel de ces biens d√©crit le mieux votre logement ?'),
      el('label',{},'Type de bien'),
      (()=>{ const s=el('select',{onInput:e=>{state.home.kind=e.target.value; state.features.type=e.target.value; deferSave();}}, [el('option',{value:'appartement'},'Appartement'), el('option',{value:'maison'},'Maison')]); s.value=state.home.kind; return s; })(),
      navActions()
    );
    return box;
  }

  if(current===2){
    const box=el('div');
    box.append(
      el('h2',{},'3. O√π le bien est-il situ√© ?'),
      makeAddressBlock(state.home),
      navActions()
    );
    return box;
  }

  if(current===3){
    const box=el('div');
    box.append(
      el('h2',{},'4. Quelles pi√®ces composent le bien ?'),
      el('div',{class:'row3'},[
        counter('Salon/s√©jour','salon'),
        counter('Cuisine','cuisine'),
        counter('Chambre','chambre'),
      ]),
      el('div',{class:'row3'},[
        counter('Salle de bain','sdb'),
        counter('WC s√©par√©','wc'),
        otherRoomsUI(),
      ]),
      el('div',{class:'muted'},'Astuce¬†: vous pourrez d√©tailler les √©quipements, photos et commentaires √† l\'√©tape 9 pour chaque pi√®ce.'),
      navActions()
    );
    return box;
  }

  if(current===4){
    const box=el('div');
    box.append(
      el('h2',{},'5. Qui r√©alise l\'√©tat des lieux ?'),
      el('div',{class:'row'},[
        el('div',{class:'checkbox'},[ (()=>{ const i=el('input',{type:'radio',name:'role',checked:state.performer.role==='proprietaire',onInput:()=>{state.performer.role='proprietaire'; deferSave();}}); return i;})(), el('label',{},'Propri√©taire') ]),
        el('div',{class:'checkbox'},[ (()=>{ const i=el('input',{type:'radio',name:'role',checked:state.performer.role==='representant',onInput:()=>{state.performer.role='representant'; deferSave();}}); return i;})(), el('label',{},'Un repr√©sentant du propri√©taire') ])
      ]),
      navActions()
    ); return box;
  }

  if(current===5){
    const box=el('div');
    box.append(
      el('h2',{},'6. Coordonn√©es de la personne qui r√©alise l\'EDL'),
      el('div',{class:'row'},[
        textInput('Pr√©nom', state.performer, 'firstname'),
        textInput('Nom', state.performer, 'lastname'),
      ]),
      el('div',{class:'row'},[
        textInput('Adresse mail', state.performer, 'email', 'email'),
        el('div')
      ]),
      makeAddressBlock(state.performer),
      navActions()
    ); return box;
  }

  if(current===6){
    const box=el('div');
    const sync = el('div',{class:'checkbox'},[ (()=>{ const i=el('input',{type:'checkbox',checked:state.tenant.useHomeAddress,onInput:e=>{state.tenant.useHomeAddress=e.target.checked; if(e.target.checked){ state.tenant.address={...state.home.address}; } deferSave(); update(); }}); return i;})(), el('label',{},"Utiliser l'adresse du logement par d√©faut") ]);

    box.append(
      el('h2',{},'7. Identit√© du locataire'),
      el('div',{class:'row'},[
        textInput('Pr√©nom', state.tenant, 'firstname'),
        textInput('Nom', state.tenant, 'lastname'),
      ]),
      el('div',{class:'row'},[
        textInput('Adresse mail', state.tenant, 'email', 'email'), el('div')
      ]),
      sync,
      state.tenant.useHomeAddress ? el('div',{class:'helper'},"L'adresse est copi√©e depuis le logement. D√©cochez pour la modifier.") : makeAddressBlock(state.tenant),
      navActions()
    ); return box;
  }

  if(current===7){
    const box=el('div');
    const f = state.features;
    box.append(
      el('h2',{},'8. Caract√©ristiques du logement'),
      el('div',{class:'row'},[
        selectInput('Type de bien', f, 'type', ['appartement','maison']),
        textInput('Surface habitable (m¬≤)', f, 'surface', 'number')
      ]),
      el('div',{class:'row'},[
        textInput('Pi√®ces (nombre total)', f, 'pieces', 'number'),
        checkInput('Location meubl√©e ?', f,'meuble')
      ]),
      el('div',{class:'divider'}),
      el('h3',{},'Chauffage'),
      el('div',{class:'row'},[
        selectInput('Type', f.chauffage,'type',['individuel','collectif']),
        selectInput('Mode', f.chauffage,'mode',['√©lectrique','gaz','fioul'])
      ]),
      el('h3',{},'Eau chaude'),
      el('div',{class:'row'},[
        selectInput('Type', f.eau,'type',['individuel','collectif']),
        selectInput('Mode', f.eau,'mode',['√©lectrique','gaz','fioul'])
      ]),
      checkInput('D√©tecteur de fum√©e ?', f,'smoke'),
      navActions()
    ); return box;
  }

  if(current===8){
    ensureRoomsFromCounts();
    const box=el('div');
    box.append(el('h2',{},"9. √âtat des pi√®ces"));
    state.rooms.forEach((room,idx)=> box.append(roomBlock(room, idx)) );
    box.append(navActions()); return box;
  }

  if(current===9){
    const box=el('div');
    box.append(el('h2',{},'10. Relev√© de compteurs'));
    box.append(el('h3',{},'Eau'));
    box.append(el('div',{class:'row'},[
      textInput('Num√©ro de compteur', state.meters.water,'number'),
      photoInput('Photo (optionnel)', state.meters.water, 'photo', 1)
    ]));
    box.append(textareaInput('Commentaire', state.meters.water, 'comment'));

    box.append(el('div',{class:'divider'}));
    box.append(el('h3',{},'√âlectricit√©'));
    box.append(el('div',{class:'row'},[
      textInput('Num√©ro de compteur', state.meters.electricity,'number'),
      photoInput('Photo (optionnel)', state.meters.electricity, 'photo', 1)
    ]));
    box.append(textareaInput('Commentaire', state.meters.electricity, 'comment'));
    box.append(navActions());
    return box;
  }

  if(current===10){
    const box=el('div');
    box.append(el('h2',{},'11. Cl√©s'));
    box.append(el('div',{class:'row'},[
      (()=>{ const w=el('div'); w.append(el('label',{},'Nombre de cl√©s remises (0 √† 3)')); const i = el('input',{type:'number',min:'0',max:'3',value:state.keys.count,onInput:e=>{const v=Math.max(0,Math.min(3,parseInt(e.target.value||'0',10))); state.keys.count=v; e.target.value=v; deferSave();}}); w.append(i); return w; })(),
      photoInput('Photo (optionnel)', state.keys, 'photo', 1)
    ]));
    box.append(textareaInput('Commentaire', state.keys, 'comment'));
    box.append(navActions());
    return box;
  }

  if(current===11){
    const box=el('div');
    box.append(el('h2',{},'12. Signatures'));

    const ownerName = `${state.performer.firstname||''} ${state.performer.lastname||''}`.trim() || 'Propri√©taire / Repr√©sentant';
    const tenantName = `${state.tenant.firstname||''} ${state.tenant.lastname||''}`.trim() || 'Locataire';

    box.append(el('label',{},'Signature du propri√©taire / repr√©sentant : '+ownerName));
    box.append(signaturePadUI('owner'));
    box.append(el('label',{},'Signature du locataire : '+tenantName));
    box.append(signaturePadUI('tenant'));
    box.append(navActions()); return box;
  }

  if(current===12){
    const box=el('div');
    box.append(el('h2',{},'13. Remarques'));
    box.append(photoMultiInput('Photos (max 10)', state.remarks, 'photos', 10));
    box.append(textareaInput('Commentaire global', state.remarks, 'comment'));
    box.append(navActions());
    return box;
  }

  if(current===13){
    const box=el('div');
    box.append(el('h2',{},'14. Export'));
    box.append(el('p',{class:'muted'},"Cliquez sur \"T√©l√©charger le PDF\" dans le panneau de droite. Deux exemplaires seront inclus (propri√©taire et locataire)."));
    box.append(el('p',{class:'muted'},"Vous pouvez aussi exporter un JSON pour sauvegarder / r√©importer plus tard."));
    box.append(navActions());
    return box;
  }
}

// ====== SUB-COMPONENTS ======
function textInput(labelTxt, obj, key, type='text'){
  const w=el('div'); w.append(el('label',{},labelTxt));
  const i=el('input',{type, value: obj[key]||'', onInput:e=>{obj[key]=e.target.value; deferSave();}});
  w.append(i); return w;
}
function textareaInput(labelTxt, obj, key){
  const w=el('div'); w.append(el('label',{},labelTxt));
  const i=el('textarea',{onInput:e=>{obj[key]=e.target.value; deferSave();}}, obj[key]||'');
  w.append(i); return w;
}
function selectInput(labelTxt, obj, key, options){
  const w=el('div'); w.append(el('label',{},labelTxt));
  const s=el('select',{onInput:e=>{obj[key]=e.target.value; deferSave();}}, options.map(o=>el('option',{value:o},o)) ); s.value=obj[key]||options[0]; w.append(s); return w;
}
function checkInput(labelTxt, obj, key){
  const w=el('div',{class:'checkbox'}); const i = el('input',{type:'checkbox',checked:!!obj[key],onInput:e=>{obj[key]=e.target.checked; deferSave();}});
  w.append(i, el('label',{},labelTxt)); return w;
}
function counter(labelTxt, key){
  const w=el('div'); w.append(el('label',{},labelTxt));
  const i=el('input',{type:'number',min:'0',max:'5',value:state.roomCounts[key]||0, onInput:e=>{const v=Math.max(0,Math.min(5,parseInt(e.target.value||'0',10))); state.roomCounts[key]=v; e.target.value=v; deferSave();}});
  w.append(i); return w;
}
function otherRoomsUI(){
  const wrap=el('div'); wrap.append(el('label',{},'Autres pi√®ces (optionnel)'));
  const list=el('div',{class:'chips'});
  const add=el('div',{class:'row'},[
    el('input',{type:'text',placeholder:'Ex¬†: Bureau, Cellier‚Ä¶', id:'otherName'}),
    el('button',{onClick:()=>{ const v=document.getElementById('otherName').value.trim(); if(!v) return; state.roomCounts.autres.push(v); document.getElementById('otherName').value=''; update(); deferSave(); }},'+ Ajouter')
  ]);
  (state.roomCounts.autres||[]).forEach((name,idx)=>{
    const c=el('span',{class:'chip'}, name+' ');
    c.appendChild(el('span',{class:'muted',style:'margin-left:6px;cursor:pointer',onClick:()=>{state.roomCounts.autres.splice(idx,1); update(); deferSave();}},'‚úï'));
    list.appendChild(c);
  });
  wrap.append(add,list); return wrap;
}

function ensureRoomsFromCounts(){
  const desired=[];
  const pushN=(base,n)=>{ for(let i=1;i<=n;i++) desired.push(base+(n>1?' '+i:'')); };
  pushN('Salon/s√©jour', state.roomCounts.salon||0);
  pushN('Cuisine', state.roomCounts.cuisine||0);
  pushN('Chambre', state.roomCounts.chambre||0);
  pushN('Salle de bain', state.roomCounts.sdb||0);
  pushN('WC s√©par√©', state.roomCounts.wc||0);
  (state.roomCounts.autres||[]).forEach(a=>desired.push(a));

  // Reconcile state.rooms with desired names
  const existingByName = new Map(state.rooms.map(r=>[r.name,r]));
  state.rooms = desired.map(name=> existingByName.get(name) || { name, equipments:[], photos:[], comment:'' });
}

function roomBlock(room, idx){
  const box = el('div',{class:'room'});
  box.append(el('h3',{}, room.name));
  // Equipements
  const equipInput = el('input',{type:'text',placeholder:'Ajouter un √©quipement et appuyez sur Entr√©e'});
  equipInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ const v=equipInput.value.trim(); if(v){ room.equipments.push(v); equipInput.value=''; deferSave(); update(); } }});
  const chips = el('div',{class:'chips'});
  room.equipments.forEach((eq,i)=>{
    const chip = el('span',{class:'chip'}, eq+' ');
    chip.appendChild(el('span',{class:'muted',style:'margin-left:6px;cursor:pointer',onClick:()=>{room.equipments.splice(i,1); deferSave(); update();}},'‚úï'));
    chips.appendChild(chip);
  });

  box.append(el('label',{},'√âquipements fournis'), equipInput, chips);
  // Photos
  box.append(photoMultiInput('Photos (max 15)', room, 'photos', 15));
  // Commentaire
  box.append(textareaInput('Commentaire', room, 'comment'));
  return box;
}

function photoInput(labelTxt, obj, key, max=1){
  const wrap=el('div'); wrap.append(el('label',{},labelTxt));
  const inp=el('input',{type:'file',accept:'image/*',onChange: async e=>{
    const f=e.target.files[0]; if(!f) return; obj[key]=await compressImage(f); e.target.value=''; deferSave(); update();
  }});
  wrap.append(inp);
  if(obj[key]){
    const img=el('img',{src:obj[key],style:'width:100%;margin-top:8px;border-radius:10px;border:1px solid #2a3a7a'});
    const rm=el('div',{class:'actions'},[ el('button',{class:'ghost',onClick:()=>{obj[key]=null; update(); deferSave();}},'Retirer') ]);
    wrap.append(img, rm);
  }
  return wrap;
}

function photoMultiInput(labelTxt, obj, key, max){
  const wrap=el('div'); wrap.append(el('label',{},labelTxt));
  const list = obj[key]||[]; if(!obj[key]) obj[key]=[];
  const inp=el('input',{type:'file',accept:'image/*',multiple:true,onChange: async e=>{
    const files=[...e.target.files];
    for(const f of files){ if(obj[key].length>=max) break; const url=await compressImage(f); obj[key].push({name:f.name, data:url}); }
    e.target.value=''; deferSave(); update();
  }});
  wrap.append(inp);
  const gallery=el('div',{class:'photos'});
  list.forEach((p,i)=>{
    const tile=el('div',{class:'photo'},[ el('img',{src:p.data,alt:p.name||('photo '+(i+1))}), el('small',{},(p.name||('Photo '+(i+1)))) ]);
    tile.appendChild(el('div',{style:'position:absolute;top:6px;right:6px'}, el('button',{class:'ghost',onClick:()=>{obj[key].splice(i,1); update(); deferSave();}},'‚úï')));
    gallery.appendChild(tile);
  });
  wrap.append(gallery);
  return wrap;
}

function signaturePadUI(key){
  const box=el('div');
  const c = el('canvas',{class:'sig-pad'}); c.height=180; c.width=900; // responsive via CSS width
  box.append(c);
  let pad;
  setTimeout(()=>{ pad = new SignaturePad(c,{backgroundColor:'#07102b', penColor:'#fff'}); if(state.signatures[key]){ // display existing
    const img=new Image(); img.src=state.signatures[key]; img.onload=()=>{ const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); };
  }
  },0);
  const actions=el('div',{class:'actions'},[
    el('button',{class:'ghost',onClick:()=>{ pad && pad.clear(); state.signatures[key]=null; deferSave(); }},'Effacer'),
    el('button',{class:'primary',onClick:()=>{ if(!pad) return; if(pad.isEmpty()){ toast('Signature vide'); return; } state.signatures[key]=c.toDataURL('image/png'); deferSave(); toast('Signature enregistr√©e'); }},'Enregistrer la signature')
  ]);
  box.append(actions); return box;
}

// ====== SUMMARY ======
function renderSummary(){
  const s = document.getElementById('summary');
  const addr = a=> `${a.voie||''}${a.cp?(', '+a.cp):''}${a.ville?(' '+a.ville):''}` || '‚Äî';
  s.innerHTML='';
  const tbl = el('table',{class:'table'});
  tbl.append(
    tr('Type EDL', cap(state.edlType)),
    tr('Bien', cap(state.home.kind)),
    tr('Adresse logement', addr(state.home.address)),
    tr('R√©alis√© par', state.performer.role==='proprietaire'?'Propri√©taire':'Repr√©sentant'),
    tr('Personne', `${state.performer.firstname||''} ${state.performer.lastname||''}`.trim()||'‚Äî'),
    tr('Email', state.performer.email||'‚Äî'),
    tr('Adresse personne', addr(state.performer.address)),
    tr('Locataire', `${state.tenant.firstname||''} ${state.tenant.lastname||''}`.trim()||'‚Äî'),
    tr('Email locataire', state.tenant.email||'‚Äî'),
    tr('Adresse locataire', addr(state.tenant.useHomeAddress?state.home.address:state.tenant.address)),
    tr('Surface (m¬≤)', state.features.surface||'‚Äî'),
    tr('Pi√®ces', state.features.pieces||'‚Äî'),
    tr('Meubl√©', state.features.meuble?'Oui':'Non'),
    tr('Chauffage', `${state.features.chauffage.type} / ${state.features.chauffage.mode}`),
    tr('Eau chaude', `${state.features.eau.type} / ${state.features.eau.mode}`),
    tr('D√©tecteur fum√©e', state.features.smoke?'Oui':'Non'),
    tr('Cl√©s remises', String(state.keys.count||0)),
  );
  s.append(tbl);
}
function tr(k,v){ const r=el('tr'); r.append(el('th',{},k), el('td',{}, v)); return r; }
function cap(s){ return (s||'').slice(0,1).toUpperCase()+(s||'').slice(1); }

// ====== PDF EXPORT ======
async function exportPDF(){
  const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'mm', format:'a4'});
  const margin=12; let y=margin; const pageW=210, pageH=297, maxW=pageW-2*margin;
  const addH = h=>{ if(y+h>pageH-margin){ doc.addPage(); y=margin; } };
  const h1 = (t)=>{ addH(10); doc.setFontSize(16); doc.setTextColor(20,40,120); doc.text(t, margin, y); y+=8; line(); };
  const h2 = (t)=>{ addH(8); doc.setFontSize(13); doc.setTextColor(20,20,20); doc.text(t, margin, y); y+=6; };
  const p = (t)=>{ doc.setFontSize(11); doc.setTextColor(10,10,10); const lines = doc.splitTextToSize(t, maxW); addH(5+lines.length*5); doc.text(lines, margin, y); y+=lines.length*5; };
  const line=()=>{ doc.setDrawColor(210,210,230); doc.line(margin, y, pageW-margin, y); y+=3; };
  const img = async (data, maxWmm=maxW)=>{
    const im = new Image(); im.src=data; await im.decode();
    const ratio = im.width/im.height; const w = Math.min(maxWmm, maxWmm); const h = w/ratio; addH(h+4); doc.addImage(data, 'JPEG', margin, y, w, h, undefined,'FAST'); y+=h+2; };

  const twoCopies = [ 'EXEMPLAIRE PROPRI√âTAIRE', 'EXEMPLAIRE LOCATAIRE' ];
  for(let copyIdx=0; copyIdx<2; copyIdx++){
    if(copyIdx>0){ doc.addPage(); y=margin; }
    doc.setFont('helvetica','bold'); h1(`√âTAT DES LIEUX ‚Äì ${state.edlType.toUpperCase()} ‚Ä¢ ${twoCopies[copyIdx]}`);
    doc.setFont('helvetica','normal');
    p(`Date: ${new Date().toLocaleDateString('fr-FR')}\n`+
      `Logement: ${cap(state.home.kind)}\n`+
      `Adresse: ${state.home.address.voie||''}, ${state.home.address.cp||''} ${state.home.address.ville||''}`);
    line();

    h2('R√©alisateur');
    p(`${state.performer.role==='proprietaire'?'Propri√©taire':'Repr√©sentant'} ‚Äì ${state.performer.firstname||''} ${state.performer.lastname||''}\n`+
      `Email: ${state.performer.email||'‚Äî'}\n`+
      `Adresse: ${state.performer.address.voie||''}, ${state.performer.address.cp||''} ${state.performer.address.ville||''}`);

    h2('Locataire');
    const ta = state.tenant.useHomeAddress? state.home.address : state.tenant.address;
    p(`${state.tenant.firstname||''} ${state.tenant.lastname||''}\n`+
      `Email: ${state.tenant.email||'‚Äî'}\n`+
      `Adresse: ${ta.voie||''}, ${ta.cp||''} ${ta.ville||''}`);

    h2('Caract√©ristiques');
    p(`Type: ${state.features.type}, Surface: ${state.features.surface||'‚Äî'} m¬≤, Pi√®ces: ${state.features.pieces||'‚Äî'}\n`+
      `Meubl√©: ${state.features.meuble?'Oui':'Non'}\n`+
      `Chauffage: ${state.features.chauffage.type} / ${state.features.chauffage.mode}\n`+
      `Eau chaude: ${state.features.eau.type} / ${state.features.eau.mode}\n`+
      `D√©tecteur de fum√©e: ${state.features.smoke?'Oui':'Non'}`);

    h2('√âtat des pi√®ces');
    ensureRoomsFromCounts();
    if(!state.rooms.length) p('‚Äî Aucune pi√®ce ‚Äî');
    for(const r of state.rooms){
      h2('‚Ä¢ '+r.name);
      if((r.equipments||[]).length) p('√âquipements: '+r.equipments.join(', ')); else p('√âquipements: ‚Äî');
      if(r.comment) p('Commentaire: '+r.comment);
      if((r.photos||[]).length){ for(const ph of r.photos){ await img(ph.data); } }
      line();
    }

    h2('Compteurs');
    p(`Eau ‚Äì N¬∞: ${state.meters.water.number||'‚Äî'}`); if(state.meters.water.photo) await img(state.meters.water.photo); if(state.meters.water.comment) p('Commentaire: '+state.meters.water.comment);
    p(`√âlectricit√© ‚Äì N¬∞: ${state.meters.electricity.number||'‚Äî'}`); if(state.meters.electricity.photo) await img(state.meters.electricity.photo); if(state.meters.electricity.comment) p('Commentaire: '+state.meters.electricity.comment);

    h2('Cl√©s');
    p(`Nombre remis: ${state.keys.count||0}`); if(state.keys.photo) await img(state.keys.photo); if(state.keys.comment) p('Commentaire: '+state.keys.comment);

    h2('Remarques');
    if(state.remarks.comment) p(state.remarks.comment);
    if((state.remarks.photos||[]).length){ for(const ph of state.remarks.photos){ await img(ph.data); } }

    h2('Signatures');
    if(state.signatures.owner){ await img(state.signatures.owner, 80); p((state.performer.firstname||'')+' '+(state.performer.lastname||'')); }
    if(state.signatures.tenant){ await img(state.signatures.tenant, 80); p((state.tenant.firstname||'')+' '+(state.tenant.lastname||'')); }

    p('Fait le '+new Date().toLocaleDateString('fr-FR'));
  }

  const safeVille = (state.home.address.ville||'').replace(/[^a-z0-9\-\s]/gi,'').trim().replace(/\s+/g,'_');
  const fname = `EDL_${state.edlType}_${safeVille||'Document'}.pdf`;
  doc.save(fname);
}

// ====== EVENTS (IMPORT/EXPORT/RESET) ======
document.getElementById('btnPDF').addEventListener('click', exportPDF);

document.getElementById('btnExportJSON').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='edl_brouillon.json'; a.click(); URL.revokeObjectURL(a.href);
});

document.getElementById('btnImportJSON').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async e=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); try{ const js=JSON.parse(txt); state=js; saveState(); update(); toast('Brouillon import√©'); }catch(err){ toast('Fichier invalide'); } };
  inp.click();
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('Effacer toutes les donn√©es et repartir de z√©ro¬†?')){ state = emptyState(); saveState(); update(); }
});

// ====== INIT ======
function update(){ render(); }
render();

</script>
</body>
</html>
